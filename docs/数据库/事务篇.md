# 事务篇
## 1 事务的隔离级别
### 1.1 事务的概念
### 1.2 事务的特性
|特性|内容|
|---|---|
|原子性（Atomicity）|一个事务中的所有操作，要么全部完成，要么不完成，不会结束在中间某个环节，而且事务在执行过程中发生错误，会被回滚回到事务开始前的状态，就好像这个事务从来没有执行过一样。|
|一致性（Consistency）|事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态。|
|隔离性（Isolation）|数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致，因为多个事务同时使用相同的数据时，不会相互干扰，每个事务都有一个完整的数据空间，对其他并发事务是隔离的。也就是说，消费者购买这个商品这个事务，是不影响其他消费者购买的。|
|持久性（Durability）|事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。|

### 1.3 并行的事务
mysql服务端是允许多个客户端连接的，这意味着mysql会出现同时处理多个事务的情况。那么在处理多个事务的时候，就有可能出现**脏读**，**不可重复读**，**幻读**的问题。

|问题|具体描述|
|---|---|
|脏读|如果一个事务读到了另一个未提交事务修改过的数据，就意味着发生了脏读现象。|
|不可重复读|在一个事务内多次读取同一个数据，如果出现前后两次读到的数据不一样的情况，就意味着发生了不可重复读的现象。|
|幻读|在一个事务内多次查询某个符合查询条件的记录数量，如果出现前后两次查询到的记录数量不一样的情况，就意味着出现了幻读现象。|
* 脏读，假设有A和B两个事务同时在处理，事务A先开始从数据库中读取余额数据，然后再执行更新操作，如果此时事务A还没有提交事务，而此时事务B也从数据库中读取余额数据，那么事务B读取到的余额是刚才事务A更新后的数据，即便事务A没有提交事务。
* 不可重复读，假设有A和B两个事务同时在处理，事务A先开始从数据库中读取余额数据
* 幻读，
### 1.4 事务的隔离级别
事务的隔离级别分为读未提交，读提交、可重复读、串行化：
* 在读未提交隔离级别下，可能发生脏读、不可重复读和幻读现象；
* 在读提交隔离级别下，可能发生不可重复读和幻读现象；
* 在可重复读隔离级别下，可能发生幻读现象；
* 在串行化隔离级别下，脏读、不可重复读和幻读都不可能发生。

这四种隔离级别是如何实现的呢？
* 对于读未提交的隔离级别，无需特别操作
* 对于串行化的隔离级别，通过加读写锁的方式实现
* 对于读提交和重复读隔离级别的事务来说，通过`Read View`实现

### 1.5 Read View
Read View有四个重要的字段：
* `m_ids`：指的是在创建Read View时，当前数据库中活跃事务的事务id列表，注意是一个列表，“活跃事务”指启动了但还没有提交的事务；
* `min_trx_idx`：指的是创建Read View时，当前数据库中活跃事务中事务id最小的事务，也就是`m_ids`的最小值；
* `max_trx_idx`：这个并不是m_ids的最大值，而是创建Read View时当前数据库中应该给下一个事务的id值，也就是全局事务中最大的事务id值+1；
* `creator_trx_id`：指得是创建该Read View的事务的事务id。

处理知道Read View的字段，还需要介绍聚簇索引记录中的两个隐藏列：
* `trx_id`：当一个事务对某条聚簇索引记录进行改动时，就会把该事务的事务id记录在`trx_id`隐藏列里
* `roll_pointer`：每次对某条聚簇索引记录进行改动时，都会把旧版本的记录写入到undo日志中，然后这个隐藏列是个指针，指向每个旧版本记录。

当一个事务去访问记录的时候，除了自己的更新记录总是可见以外，还有以下几种情况：
* 如果记录的 trx_id 值小于 Read View 中的 min_trx_id 值，表示这个版本的记录是在创建 Read View 前已经提交的事务生成的，所以该版本的记录对当前事务可见。
* 如果记录的 trx_id 值大于等于 Read View 中的 max_trx_id 值，表示这个版本的记录是在创建 Read View 后才启动的事务生成的，所以该版本的记录对当前事务不可见。
* 如果记录的 trx_id 值在 Read View 的 min_trx_id 和 max_trx_id 之间，需要判断 trx_id 是否在 m_ids 列表中：
    * 如果记录的 trx_id 在 m_ids 列表中，表示生成该版本记录的活跃事务依然活跃着（还没提交事务），所以该版本的记录对当前事务不可见。
    * 如果记录的 trx_id 不在 m_ids 列表中，表示生成该版本记录的活跃事务已经被提交，所以该版本的记录对当前事务可见。
### 1.6 可重复读
可重复读隔离级别是启动事务时生成一个Read View，然后整个事务期间都在使用这个Read View。
### 1.7 读提交
读提交隔离级别是在每次读取数据时，都会生成一个新的Read View。